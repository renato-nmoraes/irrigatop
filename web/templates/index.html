<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IrrigaTOP</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <div class="top-bar">
    <h1 class="title">IrrigaTOP</h1>
  </div>
  <form id="pump-form" action="/pump" method="POST">
    <div class="pump-select-container">
      <label for="pump-select">Selecione a bomba:</label>
      <div class="custom-dropdown" id="pump-select">
        <span class="selected-pump">Bomba 1</span>
        <ul class="dropdown-options">
          <div data-value="1" class="pump-option">Bomba 1</div>
          <div data-value="2" class="pump-option">Bomba 2</div>
        </ul>
      </div>
    </div>
    <input type="hidden" name="pump_id" id="pump_id">
  </form>
  <form method="POST">
    <div class="container">
      <div class="state-container">
        <div>
          <span class="state-label">Status da bomba:</span>
          <span id="state-placeholder" class="state-value">
            <!-- {{ pump_status }} -->
          </span>
        </div>
        <div class="health-status">
          <span>Conex√£o:</span>
          <div id="health-indicator" class="health-indicator offline"></div>
        </div>
      </div>
      <div class="button-container">
        <button type="submit" name="action" value="ON" class="button button-action button-on">ON</button>
        <button type="submit" name="action" value="OFF" class="button button-action button-off">OFF</button>
      </div>
      <div class="button-container">
        <button type="submit" name="action" value="PULSE" class="button button-action button-pulse">PULSE</button>
      </div>
    </div>
  </form>
  <form method="POST" action="/intensity" id="slider-form">
    <div class="slider-container">
      <input type="range" value="0" min="0" max="100" name="slider" id="range">
      <input type="number" id="rangenumber" min="0" max="100" value="0">
    </div>
  </form>
  <div id="notification" class="notification"></div>
  <script>
    $(document).ready(() => {
      const $slider = $("#range");
      const $sliderValue = $("#rangenumber");
      const $statePlaceholder = $("#state-placeholder");
      const $pumpSelect = $("#pump-select");
      const $pumpForm = $("#pump-form");
  
      // Notification function
      function showNotification(message, type = 'error') {
        const $notification = $('#notification');
        $notification
          .text(message)
          .removeClass('error success')
          .addClass(type)
          .addClass('show');
  
        setTimeout(() => {
          $notification.removeClass('show');
        }, 3000);
      }
  
      // Update the pump status and health status every 5 seconds
      const updateStatus = () => {
        $.getJSON("/status")
          .done((data) => {
            if (data.success) {
              $statePlaceholder.text(data.status || "Unknown");
            } else {
              showNotification(data.message);
            }
          })
          .fail(() => {
            showNotification("Failed to fetch pump status");
          });
  
        $.getJSON("/health")
          .done((data) => {
            const $healthIndicator = $("#health-indicator");
            $healthIndicator
              .removeClass("online offline")
              .addClass(data.status);
          })
          .fail(() => {
            $("#health-indicator").removeClass("online").addClass("offline");
          });
      };
      setInterval(updateStatus, 5000);
      updateStatus();
  
      // Handle pump action buttons
      $("form button[name='action']").click(function(event) {
        event.preventDefault();
        const action = $(this).val();
        
        $.ajax({
          url: "/",
          type: "POST",
          data: { action: action },
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          success: function(response) {
            if (response.success) {
              showNotification(response.message, 'success');
              updateStatus();
            } else {
              showNotification(response.message);
            }
          },
          error: function() {
            showNotification("Failed to send command to pump");
          }
        });
      });
  
      // Handle slider updates
      function updateSlider(value) {
        $.post("/intensity", { slider: value })
          .done((response) => {
            if (response.success) {
              showNotification(response.message, 'success');
            } else {
              showNotification(response.message);
            }
          })
          .fail(() => {
            showNotification("Failed to update intensity");
          });
      }
  
      $slider.on("input change", function() {
        const value = $(this).val();
        $sliderValue.val(value);
        debounce(() => updateSlider(value), 300);
      });
  
      $sliderValue.on("change", function() {
        const value = $(this).val();
        $slider.val(value);
        updateSlider(value);
      });
  
      // Handle pump selection dropdown
      $pumpSelect.on("click", function() {
        $(this).toggleClass("active");
      });
  
      $pumpSelect.on("click", ".pump-option", function(event) {
        event.stopPropagation();
        const selectedText = $(this).text();
        const pumpId = $(this).data("value");
        
        $pumpSelect.find(".selected-pump").text(selectedText);
        $pumpSelect.removeClass("active");
        $("#pump_id").val(pumpId);
  
        $.ajax({
          url: $pumpForm.attr("action"),
          type: "POST",
          data: $pumpForm.serialize(),
          success: function(response) {
            if (response.success) {
              showNotification(response.message, 'success');
            } else {
              showNotification(response.message);
            }
          },
          error: function() {
            showNotification("Failed to select pump");
          }
        });
      });
  
      // Close dropdown when clicking outside
      $(document).on("click", function(event) {
        if (!$(event.target).closest('.custom-dropdown').length) {
          $pumpSelect.removeClass("active");
        }
      });
  
      // Debounce function
      let debounceTimeout;
      function debounce(fn, delay) {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(fn, delay);
      }

      // Add this to update slider background as it moves
      $slider.on("input", function() {
        const value = ((this.value - this.min) / (this.max - this.min)) * 100;
        this.style.background = `linear-gradient(to right, #3498db 0%, #3498db ${value}%, #2c3e50 ${value}%, #2c3e50 100%)`;
      });
    });
  </script>


</body>

</html>
