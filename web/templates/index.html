<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IrrigaTOP</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <div class="top-bar">
    <h1 class="title">IrrigaTOP</h1>
  </div>
  <form id="pump-form" action="/pump" method="POST">
    <div class="pump-select-container">
      <label for="pump-select">Selecione a bomba:</label>
      <div class="custom-dropdown" id="pump-select">
        <span class="selected-pump">Bomba 1</span>
        <ul class="dropdown-options">
          <div data-value="1" class="pump-option">Bomba 1</div>
          <div data-value="2" class="pump-option">Bomba 2</div>
        </ul>
      </div>
    </div>
    <input type="hidden" name="pump_id" id="pump_id">
  </form>
  <form method="POST">
    <div class="container">
      <div class="state-container">
        <span class="state-label">Status da bomba:</span>
        <span id="state-placeholder" class="state-value">
          <!-- {{ pump_status }} -->
        </span>
      </div>
      <div class="button-container">
        <button type="submit" name="action" value="ON" class="button button-action button-on">ON</button>
        <button type="submit" name="action" value="OFF" class="button button-action button-off">OFF</button>
      </div>
      <div class="button-container">
        <button type="submit" name="action" value="PULSE" class="button button-action button-pulse">PULSE</button>
      </div>
    </div>
  </form>
  <form method="POST" action="/intensity" id="slider-form">
    <div class="slider-container">
      <input type="range" value="0" min="0" max="100" name="slider" id="range"">
      <input type="number" id="rangenumber" min="0" max="100" value="0">
    </div>
  </form>
  <script>
    $(document).ready(() => {
      const $slider = $("#range");
      const $sliderValue = $("#rangenumber");
      const $statePlaceholder = $("#state-placeholder");
      const $pumpSelect = $("#pump-select");
      const $pumpForm = $("#pump-form");
  
      // Update the pump status and health status every 5 seconds
      const updateStatus = () => {
        $.getJSON("/status", (data) => $statePlaceholder.text(data.status || "Unknown"));
        // Additional health-check status can be updated here if required
      };
      setInterval(updateStatus, 5000);
      updateStatus();
  
      // Handle pump action buttons
      $("#action-form button").click(function (event) {
        event.preventDefault();
        const action = $(this).data("action");
        $.post("/", { action })
          .done(() => updateStatus())
          .fail((error) => console.error("Action failed:", error));
      });
  
      // Handle slider updates
      $slider.on("input change", function () {
        const value = $(this).val();
        $sliderValue.val(value);
        debounce(() => $.post("/intensity", { slider: value })
          .fail((error) => console.error("Slider update failed:", error)), 300);
      });
  
      $sliderValue.on("change", function () {
        const value = $(this).val();
        $slider.val(value).trigger("change");
      });
  
      // Handle pump selection dropdown
      $pumpSelect.on("click", function () {
        $(this).toggleClass("active");
      });
  
      $pumpSelect.on("click", ".pump-option", function () {
        const selectedText = $(this).text();
        // Set the selected pump text and update hidden pump ID input field
        $pumpSelect.find(".selected-pump").text(selectedText);
        $pumpSelect.removeClass("active");

        const pumpId = $(this).data("value");
        $("#pump_id").val(pumpId);

        // Send the selected pump ID to the server
        $.ajax({
          url: $pumpForm.attr("action"),
          type: "POST",
          data: $pumpForm.serialize(),
          success: function (data) {
            console.log("Pump selection sent successfully:", data.pump_id);
          },
          error: function (error) {
            console.error("Error sending pump selection:", error);
          }
        });
      });

      // Debounce function to limit the number of times a function is executed
      let debounceTimeout;
      function debounce(fn, delay) {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(fn, delay);
      }
    });
  </script>


</body>

</html>
